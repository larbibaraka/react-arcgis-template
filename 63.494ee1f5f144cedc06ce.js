(function(){(this||window).webpackJsonp.registerAbsMids({"esri/geometry/support/normalizeUtils":104,"esri/tasks/operations/urlUtils":117,"esri/tasks/Task":140,"esri/tasks/geometry/cut":142,"esri/tasks/geometry/simplify":143,"esri/tasks/operations/query":171,"esri/tasks/operations/queryAttachments":198,"esri/tasks/QueryTask":211,"esri/tasks/operations/queryRelatedRecords":212,"esri/layers/graphics/sources/StreamLayerSource":2367,"esri/layers/support/WebSocketConnector":2368})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{104:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(31),r(32),r(7),r(36),r(37),r(40),r(34),r(114),r(115),r(50),r(63),r(90),r(142),r(143)],void 0===(o=function(e,t,r,n,o,i,s,u,a,c,l,f,h,p,d,y){function m(e){return"polygon"===e.type}function v(e){return"polygon"===e[0].type}function g(e){return"polyline"===e[0].type}function S(e){return m(e)?e.rings:e.paths}function k(e,t){return Math.ceil((e-t)/(2*t))}function b(e,t){for(var r=0,n=S(e);r<n.length;r++)for(var o=0,i=n[r];o<i.length;o++){i[o][0]+=t}return e}function x(e){for(var t=[],r=0,n=0,o=0;o<e.length;o++){for(var i=e[o],s=null,u=0;u<i.length;u++)s=i[u],t.push(s),0===u?n=r=s[0]:(r=Math.min(r,s[0]),n=Math.max(n,s[0]));s&&t.push([(r+n)/2,0])}return t}function O(e,t){if(!(e instanceof l||e instanceof c)){var r="straightLineDensify: the input geometry is neither polyline nor polygon";throw P.error(r),new i(r)}for(var n=[],o=0,s=S(e);o<s.length;o++){var u=s[o],a=[];n.push(a),a.push([u[0][0],u[0][1]]);for(var f=0;f<u.length-1;f++){var h=u[f][0],p=u[f][1],d=u[f+1][0],y=u[f+1][1],v=Math.sqrt((d-h)*(d-h)+(y-p)*(y-p)),g=(y-p)/v,k=(d-h)/v,b=v/t;if(b>1){for(var x=1;x<=b-1;x++){var O=x*t,_=k*O+h,w=g*O+p;a.push([_,w])}var j=(v+Math.floor(b-1)*t)/2,N=k*j+h,F=g*j+p;a.push([N,F])}a.push([d,y])}}return m(e)?new c({rings:n,spatialReference:e.spatialReference}):new l({paths:n,spatialReference:e.spatialReference})}function _(e,t,r){if(t){var n=O(e,1e6);e=p.webMercatorToGeographic(n,!0)}return r&&(e=b(e,r)),e}function w(e,t,r){var n;if(Array.isArray(e)){if((n=e[0])>t){var o=k(n,t);e[0]=n+o*(-2*t)}else if(n<r){o=k(n,r);e[0]=n+o*(-2*r)}}else if((n=e.x)>t){o=k(n,t);e=e.clone().offset(o*(-2*t),0)}else if(n<r){o=k(n,r);e=e.clone().offset(o*(-2*r),0)}return e}function j(e,t){for(var r=-1,n=0;n<t.cutIndexes.length;n++)!function(n){for(var o=t.cutIndexes[n],i=t.geometries[n],s=S(i),u=0;u<s.length;u++)!function(e){var t=s[e];t.some(function(r){if(r[0]<180)return!0;for(var n=0,o=0;o<t.length;o++){var s=t[o][0];n=s>n?s:n}for(var u=-360*k(n=Number(n.toFixed(9)),180),a=0;a<t.length;a++){var c=i.getPoint(e,a);i.setPoint(e,a,c.clone().offset(u,0))}return!0})}(u);if(o===r){if(v(e))for(var a=0,c=S(i);a<c.length;a++){var l=c[a];e[o]=e[o].addRing(l)}else if(g(e))for(var f=0,h=S(i);f<h.length;f++){var p=h[f];e[o]=e[o].addPath(p)}}else r=o,e[o]=i}(n);return e}Object.defineProperty(t,"__esModule",{value:!0});var P=s.getLogger("esri.geometry.support.normalizeUtils"),N={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new l({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:f.WebMercator}),minus180Line:new l({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:f.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new l({paths:[[[180,-180],[180,180]]],spatialReference:f.WGS84}),minus180Line:new l({paths:[[[-180,-180],[-180,180]]],spatialReference:f.WGS84})}};t.straightLineDensify=O,t.normalizeCentralMeridian=function e(t,i,s){return n(this,void 0,void 0,function(){var n,f,m,v,g,S,x,O,P,F,J,R,U,q,I,T,M,Q,C,E,z,L,A,W,D,G,V,B,X,H,K,Y,Z,$,ee,te,re;return r(this,function(r){switch(r.label){case 0:if(!Array.isArray(t))return[2,e([t],i)];for(n=i?i.url:o.geometryServiceUrl,F=0,J=[],R=[],U=0,q=t;U<q.length;U++)I=q[U],u.isNone(I)?R.push(I):(f||(f=I.spatialReference,m=h.getInfo(f),v=f.isWebMercator,g=N[x=v?102100:4326].maxX,S=N[x].minX,O=N[x].plus180Line,P=N[x].minus180Line),m?"mesh"===I.type?R.push(I):"point"===I.type?R.push(w(I.clone(),g,S)):"multipoint"===I.type?((T=I.clone()).points=T.points.map(function(e){return w(e,g,S)}),R.push(T)):"extent"===I.type?(Q=I.clone(),M=Q._normalize(!1,!1,m),R.push(M.rings?new c(M):M)):I.extent?(Q=I.extent,C=k(Q.xmin,S),z=0==(E=C*(2*g))?I.clone():b(I.clone(),E),Q.offset(E,0),Q.intersects(O)&&Q.xmax!==g?(F=Q.xmax>F?Q.xmax:F,z=_(z,v),J.push(z),R.push("cut")):Q.intersects(P)&&Q.xmin!==S?(F=Q.xmax*(2*g)>F?Q.xmax*(2*g):F,z=_(z,v,360),J.push(z),R.push("cut")):R.push(z)):R.push(I.clone()):R.push(I));for(L=k(F,g),A=-90,W=L,D=new l;L>0;)G=360*L-180,D.addPath([[G,A],[G,-1*A]]),A*=-1,L--;return J.length>0&&W>0?[4,d.cut(n,J,D,s)]:[3,3];case 1:for(V=r.sent(),B=j(J,V),X=[],H=[],ee=0;ee<R.length;ee++)"cut"!==(te=R[ee])?H.push(te):(re=B.shift(),K=t[ee],u.isSome(K)&&"polygon"===K.type&&K.rings&&K.rings.length>1&&re.rings.length>=K.rings.length?(X.push(re),H.push("simplify")):H.push(v?p.geographicToWebMercator(re):re));return X.length?[4,y.simplify(n,X,s)]:[2,H];case 2:for(Y=r.sent(),Z=[],ee=0;ee<H.length;ee++)"simplify"!==(te=H[ee])?Z.push(te):Z.push(v?p.geographicToWebMercator(Y.shift()):Y.shift());return[2,Z];case 3:for($=[],ee=0;ee<R.length;ee++)"cut"!==(te=R[ee])?$.push(te):(re=J.shift(),$.push(!0===v?p.geographicToWebMercator(re):re));return[2,a.resolve($)]}})})},t.getDenormalizedExtent=function(e){var t;if(!e)return null;var r=e.extent;if(!r)return null;var n=e.spatialReference&&h.getInfo(e.spatialReference);if(!n)return r;var o,i=n.valid,s=i[0],u=i[1],a=2*u,c=r.width,l=r.xmin,f=r.xmax;if(l=(t=[f,l])[0],f=t[1],"extent"===e.type||0===c||c<=u||c>a||l<s||f>u)return r;switch(e.type){case"polygon":if(!(e.rings.length>1))return r;o=x(e.rings);break;case"polyline":if(!(e.paths.length>1))return r;o=x(e.paths);break;case"multipoint":o=e.points}for(var p=r.clone(),d=0;d<o.length;d++){var y=o[d][0];y<0?(y+=u,f=Math.max(y,f)):(y-=u,l=Math.min(y,l))}return p.xmin=l,p.xmax=f,p.width<c?(p.xmin-=u,p.xmax-=u,p):r},t.normalizeMapX=function(e,t){var r=h.getInfo(t);if(r){var n=r.valid,o=n[0],i=n[1],s=i-o;if(e<o)for(;e<o;)e+=s;if(e>i)for(;e>i;)e-=s}return e}}.apply(null,n))||(e.exports=o)},117:function(e,t,r){var n,o;n=[r.dj.c(e.i),t],void 0===(o=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapParameters=function e(t){var r={};for(var n in t)if("declaredClass"!==n){var o=t[n];if(null!=o&&"function"!=typeof o)if(Array.isArray(o)){r[n]=[];for(var i=0;i<o.length;i++)r[n][i]=e(o[i])}else"object"==typeof o?o.toJSON&&(r[n]=JSON.stringify(o)):r[n]=o}return r}}.apply(null,n))||(e.exports=o)},140:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(29),r(28),r(83),r(35),r(47),r(39),r(30)],void 0===(o=function(e,t,r,n,o,i,s,u,a){return function(e){function t(t){var r=e.call(this,t)||this;return r.requestOptions=null,r.url=null,r}return r(t,e),t.prototype.normalizeCtorArgs=function(e,t){return"string"!=typeof e?e:i({url:e},t)},Object.defineProperty(t.prototype,"parsedUrl",{get:function(){return this._parseUrl(this.url)},enumerable:!0,configurable:!0}),t.prototype._parseUrl=function(e){return e?u.urlToObject(e):null},t.prototype._encode=function(e,t,r){var n={};for(var o in e)if("declaredClass"!==o){var i=e[o];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){n[o]=[];for(var s=0;s<i.length;s++)n[o][s]=this._encode(i[s])}else if("object"==typeof i)if(i.toJSON){var u=i.toJSON(r&&r[o]);n[o]=t?u:JSON.stringify(u)}else n[o]=t?i:JSON.stringify(i);else n[o]=i}return n},n([a.property({readOnly:!0,dependsOn:["url"]})],t.prototype,"parsedUrl",null),n([a.property()],t.prototype,"requestOptions",void 0),n([a.property({type:String})],t.prototype,"url",void 0),n([a.subclass("esri.tasks.Task")],t)}(a.declared(s))}.apply(null,n))||(e.exports=o)},142:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(35),r(32),r(31),r(42),r(44),r(39),r(46)],void 0===(o=function(e,t,r,n,o,i,s,u,a){Object.defineProperty(t,"__esModule",{value:!0}),t.cut=function(e,t,c,l){return n(this,void 0,void 0,function(){var n,f,h,p,d,y,m;return o(this,function(o){switch(o.label){case 0:return n="string"==typeof e?u.urlToObject(e):e,f=t[0].spatialReference,h=r({},l,{query:r({},n.query,{f:"json",sr:JSON.stringify(f),target:JSON.stringify({geometryType:a.getJsonType(t[0]),geometries:t}),cutter:JSON.stringify(c)})}),[4,s(n.path+"/cut",h)];case 1:return p=o.sent(),d=p.data,y=d.cutIndexes,m=d.geometries,[2,{cutIndexes:y,geometries:(void 0===m?[]:m).map(function(e){return i.fromJSON(e).set(f)})}]}})})}}.apply(null,n))||(e.exports=o)},143:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(35),r(32),r(31),r(44),r(39),r(46)],void 0===(o=function(e,t,r,n,o,i,s,u){function a(e){return{geometryType:u.getJsonType(e[0]),geometries:e.map(function(e){return e.toJSON()})}}function c(e,t,r){var n=u.getGeometryType(t);return e.map(function(e){var t=n.fromJSON(e);return t.spatialReference=r,t})}Object.defineProperty(t,"__esModule",{value:!0}),t.simplify=function(e,t,l){return n(this,void 0,void 0,function(){var n,f,h,p;return o(this,function(o){switch(o.label){case 0:return n="string"==typeof e?s.urlToObject(e):e,f=t[0].spatialReference,h=u.getJsonType(t[0]),p=r({},l,{query:r({},n.query,{f:"json",sr:f.wkid?f.wkid:JSON.stringify(f),geometries:JSON.stringify(a(t))})}),[4,i(n.path+"/simplify",p)];case 1:return[2,c(o.sent().data,h,f)]}})})}}.apply(null,n))||(e.exports=o)},171:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(35),r(44),r(40),r(39),r(46),r(104),r(228),r(227),r(117),r(6)],void 0===(o=function(e,t,r,n,o,i,s,u,a,c,l){function f(e,t){var r=e.geometry,n=e.toJSON(),o=n;if(r&&(o.geometry=JSON.stringify(r),o.geometryType=s.getJsonType(r),o.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),n.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(o.objectIds=n.objectIds.join(",")),n.orderByFields&&(o.orderByFields=n.orderByFields.join(",")),!n.outFields||t&&(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)?delete o.outFields:-1!==n.outFields.indexOf("*")?o.outFields="*":o.outFields=n.outFields.join(","),n.outSR?o.outSR=n.outSR.wkid||JSON.stringify(n.outSR):r&&(n.returnGeometry||n.returnCentroid)&&(o.outSR=o.inSR),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(o.outStatistics=JSON.stringify(n.outStatistics)),n.pixelSize&&(o.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(o.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.source&&(o.layer=JSON.stringify({source:n.source}),delete n.source),n.timeExtent){var i=n.timeExtent,u=i.start,a=i.end;null==u&&null==a||(o.time=u===a?u:(null==u?"null":u)+","+(null==a?"null":a)),delete n.timeExtent}return o}function h(e,t,s,a,c){void 0===a&&(a={});var h="string"==typeof e?i.urlToObject(e):e,p=t.geometry?[t.geometry]:[];return a.responseType="pbf"===s?"array-buffer":"json",u.normalizeCentralMeridian(p,null,a).then(function(e){var i=e&&e[0];o.isSome(i)&&((t=t.clone()).geometry=i);var u=l.mapParameters(r({},h.query,{f:s},c,f(t,c)));return n(h.path+"/query",r({},a,{query:u}))})}Object.defineProperty(t,"__esModule",{value:!0});var p,d="Layer does not support extent calculation.";t.queryToQueryStringParameters=f,t.executeQuery=function(e,t,r){return h(e,t,"json",r)},t.executeQueryPBF=function(e,t,r,n){var o=r.useWorker?(null==p&&(p=new c.PBFWorker),p):null;return h(e,t,"pbf",n).then(function(e){var t=function(t){var r=e;return r.data=t,r};return r.useWorker?o.parseFeatureQuery(e.data,r).then(function(e){return t(e)}):t(a.parsePBFFeatureQuery(e.data,r))})},t.executeQueryForIds=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0})},t.executeQueryForCount=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})},t.executeQueryForExtent=function(e,t,r){return h(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then(function(e){var t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(d);if(t.hasOwnProperty("count"))throw new Error(d);return e})}}.apply(null,n))||(e.exports=o)},198:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(35),r(44),r(39),r(283),r(117)],void 0===(o=function(e,t,r,n,o,i,s){Object.defineProperty(t,"__esModule",{value:!0}),t.processAttachmentQueryResult=function(e,t){for(var r={},n=0,s=e;n<s.length;n++)for(var u=s[n],a=u.parentObjectId,c=u.parentGlobalId,l=0,f=u.attachmentInfos;l<f.length;l++){var h=f[l],p=h.id,d=o.addProxy(o.addTokenParameter(t+"/"+a+"/attachments/"+p)),y=i.fromJSON(h);y.set({url:d,parentObjectId:a,parentGlobalId:c}),r[a]?r[a].push(y):r[a]=[y]}return r},t.executeAttachmentQuery=function(e,t,o){var i={query:s.mapParameters(r({},e.query,{f:"json"},function(e){var t=e.toJSON();return t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),t.keywords&&(t.keywords=t.keywords.join(",")),t.globalIds&&(t.globalIds=t.globalIds.join(",")),t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t}(t)))};return o&&(i=r({},o,i)),n(e.path+"/queryAttachments",i)}}.apply(null,n))||(e.exports=o)},211:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(29),r(28),r(83),r(35),r(42),r(30),r(140),r(171),r(198),r(212),r(213),r(100),r(74),r(214)],void 0===(o=function(e,t,r,n,o,i,s,u,a,c,l,f,h,p,d,y){return function(e){function t(t){var r=e.call(this,t)||this;return r.gdbVersion=null,r.source=null,r}return r(t,e),t.prototype.execute=function(e,t){return this.executeJSON(e,t).then(function(e){return p.fromJSON(e)})},t.prototype.executeJSON=function(e,t){return c.executeQuery(this.parsedUrl,this._normalizeQuery(e),i({},this.requestOptions,t)).then(function(e){return e.data})},t.prototype.executeForCount=function(e,t){return c.executeQueryForCount(this.parsedUrl,this._normalizeQuery(e),i({},this.requestOptions,t)).then(function(e){return e.data.count})},t.prototype.executeForExtent=function(e,t){return c.executeQueryForExtent(this.parsedUrl,this._normalizeQuery(e),i({},this.requestOptions,t)).then(function(e){return{count:e.data.count,extent:s.Extent.fromJSON(e.data.extent)}})},t.prototype.executeForIds=function(e,t){return c.executeQueryForIds(this.parsedUrl,this._normalizeQuery(e),i({},this.requestOptions,t)).then(function(e){return e.data.objectIds})},t.prototype.executeRelationshipQuery=function(e,t){return e=y.from(e),(this.gdbVersion||this.source)&&(e=e.clone().set({gdbVersion:this.gdbVersion||e.gdbVersion,source:this.source||e.source})),f.executeRelationshipQuery(this.parsedUrl,e,i({},this.requestOptions,t)).then(function(e){var t=e.data,r={};return Object.keys(t).forEach(function(e){return r[e]=p.fromJSON(t[e])}),r})},t.prototype.executeAttachmentQuery=function(e,t){var r=this;return l.executeAttachmentQuery(this.parsedUrl,h.from(e),i({},this.requestOptions,t)).then(function(e){return l.processAttachmentQueryResult(e.data.attachmentGroups,r.parsedUrl.path)})},t.prototype._normalizeQuery=function(e){var t=d.from(e);return this.gdbVersion||this.source?(t===e?t.clone():t).set({gdbVersion:this.gdbVersion||e.gdbVersion,source:this.source||e.source}):t},n([u.property()],t.prototype,"gdbVersion",void 0),n([u.property()],t.prototype,"source",void 0),n([u.subclass("esri.tasks.QueryTask")],t)}(u.declared(a))}.apply(null,n))||(e.exports=o)},212:function(e,t,r){var n,o;n=[r.dj.c(e.i),t,r(35),r(44),r(117)],void 0===(o=function(e,t,r,n,o){function i(e){var t=e.toJSON();return t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.outFields&&(t.outFields=t.outFields.join(",")),t.outSpatialReference&&(t.outSR=t.outSR.wkid||JSON.stringify(t.outSR.toJSON()),delete t.outSpatialReference),t.source&&(t.layer=JSON.stringify({source:t.source}),delete t.source),t}Object.defineProperty(t,"__esModule",{value:!0}),t.toQueryStringParameters=i,t.executeRelationshipQuery=function(e,t,s){var u={query:o.mapParameters(r({},e.query,{f:"json"},i(t)))};return s&&(u=r({},s,u)),n(e.path+"/queryRelatedRecords",u).then(function(e){for(var t=e.data,r=t.geometryType,n=t.spatialReference,o={},i=0,s=t.relatedRecordGroups;i<s.length;i++){var u=s[i],a={fields:void 0,objectIdFieldName:void 0,geometryType:r,spatialReference:n,features:u.relatedRecords};if(null!=u.objectId)o[u.objectId]=a;else for(var c in u)u.hasOwnProperty(c)&&"relatedRecords"!==c&&(o[u[c]]=a)}return e.data=o,e})}}.apply(null,n))||(e.exports=o)},2367:function(e,t,r){var n,o;n=[r(277),r(47),r(154),r(38),r(39),r(34),r(54),r(2368),r(211),r(44)],void 0===(o=function(e,t,r,n,o,i,s,u,a,c){return e([t,r.EsriPromise],{declaredClass:"esri.layers.graphics.sources.StreamLayerSource",constructor:function(e){var t=e&&e.layer;t&&(this.url=t.url)},initialize:function(){this.addResolvingPromise(this._fetchLayers())},properties:{connectionInfo:{get:function(){if(this.layer.hasMemorySource||this.layer.socketUrl)return{serviceSocketUrls:[this.layer.socketUrl]};if(this.sourceJSON){var e,t,r,n,i={},s=this.sourceJSON,u=[],a=[],c=[];if(s.streamUrls&&s.streamUrls.forEach(function(e){"ws"===e.transport&&(u=e.urls,i.token=e.token)},this),u.forEach(function(e){0===e.lastIndexOf("wss",0)?c.push(e):a.push(e)}),(e="https"===o.appUrl.scheme||0===this.url.lastIndexOf("https:",0)?c:0===a.length?c:a)&&e.length>1)for(t=0;t<e.length-1;t++)n=e[r=t+Math.floor(Math.random()*(e.length-t))],e[r]=e[t],e[t]=n;return i.serviceSocketUrls=e,i}}},latestUrl:{get:function(){var e=this.sourceJSON,t=e.keepLatestArchive&&e.keepLatestArchive.featuresUrl;return t||null}},latestQueryTask:{get:function(){var e=this.latestUrl;return e?new a(e):null}},layer:{},relatedFeaturesInfo:{get:function(){var e=(this.sourceJSON||{}).relatedFeatures;return e&&e.featuresUrl?e:null}},relatedFeaturesQueryTask:{get:function(){var e=this.relatedFeaturesInfo,t=e?e.featuresUrl:null;return t?new a(t):null}},parsedUrl:{get:function(){return this.url?o.urlToObject(this.url):null}},url:null},createWebSocketConnector:function(e){var t=i.createDeferred();return this.when(function(){var r,o,i,s,a=this.connectionInfo,c=this.layer.spatialReference,l={};try{r=this.makeFilter()}catch(e){return void t.reject(e)}if(a){if(a.socketUrl?i=[a.socketUrl]:a.serviceSocketUrls&&(i=a.serviceSocketUrls.map(function(e){return e+"/"+this.layer.socketDirection}.bind(this))),l.socketUrls=i,r&&(r.where||r.geometry||r.outFields)){var f=r.geometry;f&&"string"!=typeof f&&(f=f.toJSON?JSON.stringify(f.toJSON()):JSON.stringify(f)),o=n.mixin(o||{},{where:r.where,geometry:f,outFields:r.outFields})}a.token&&(o=n.mixin(o||{},{token:a.token})),e&&c&&e.wkid!==c.wkid&&(o=n.mixin(o||{},{outSR:e.wkid})),l.queryParams=o,l.layerSource=this,s=new u(l),t.resolve(s)}else t.reject(new Error("No web socket urls found"))}.bind(this)),t.promise},getWebSocketToken:function(){return this._fetchStreamLayer().then(function(e){var t=e.data,r=null;return t.streamUrls&&t.streamUrls.some(function(e){if("ws"===e.transport)return r=e.token,!0},this),r}.bind(this))},makeFilter:function(e){var t,r=this.layer,o=null;if(e){var i;if(t={},e.hasOwnProperty("where")&&(t.where=e.where),e.hasOwnProperty("geometry")){if((i=e.geometry)&&!i.hasOwnProperty("xmin"))throw new Error("Cannot make filter. Only Extent is supported for the geometry filter");i&&!i.declaredClass&&(i=new s(i)),t.geometry=i}}else{var u=r.filter||{};t={where:u.where,geometry:u.geometry};var a=this.relatedFeaturesInfo&&this.relatedFeaturesInfo.outFields||r.outFields;if(a&&-1===a.indexOf("*")){var c=r.fields.map(function(e){return e.name});o=a.filter(function(e){return-1!==c.indexOf(e)}).join(","),t=n.mixin(t||{},{outFields:o})}}return t},queryFeatures:function(e,t){return i.reject()},_fetchLayers:function(){return this._fetchStreamLayer().then(function(e){return e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=e.data,this._fetchArchiveLayer()}.bind(this)).then(function(e){return this.archivedLayerDefinition=e&&e.data,this._fetchRelatedLayer()}.bind(this)).then(function(e){this.relatedLayerDefinition=e&&e.data}.bind(this))},_fetchStreamLayer:function(){return this._requestServiceDefinition({url:this.layer.parsedUrl.path,content:n.mixin({f:"json"},this.layer.parsedUrl.query)})},_fetchArchiveLayer:function(){var e=this.latestUrl;return e?this._requestServiceDefinition({url:e}):i.resolve()},_fetchRelatedLayer:function(){var e=this.relatedFeaturesInfo;return e?this._requestServiceDefinition({url:e.featuresUrl}):i.resolve()},_requestServiceDefinition:function(e){return e&&e.url?c(e.url,{query:n.mixin(e.content||{},{f:"json"}),responseType:"json"}):i.reject(new Error("url is a required options property"))}})}.apply(null,n))||(e.exports=o)},2368:function(e,t,r){var n,o;n=[r(106),r(154),r(39),r(34),r(56),r(36)],void 0===(o=function(e,t,r,n,o,i){return(0,t.EsriPromiseMixin)(e.EventedAccessor).createSubclass({declaredClass:"esri.layers.support.WebSocketConnector",initialize:function(){var e=null;this.socketUrls.length||(e=new Error("No urls passed to WebSocketConnector. No live connection possible")),"WebSocket"in window||(e=new Error("The browser does not support Web Sockets. No live connection possible")),e&&this.addResolvingPromise(n.reject(e)),this.queryParams&&this.queryParams.token&&this._set("tokenNeeded",!0)},_socket:null,_connectPromise:null,_disconnectPromise:null,properties:{currentSocketUrl:{value:null,readOnly:!0},layerSource:null,queryParams:null,socketUrls:{value:[]},tokenNeeded:{value:!1},connectionError:{value:null,type:i,readOnly:!0},connectionStatus:{value:"disconnected",readOnly:!0}},connect:function(){var e=this.connectionStatus;return"connected"===e||"connecting"===e?this._connectPromise:"disconnected"===this.connectionStatus?(this._set("connectionStatus","connecting"),this._connect()):"disconnecting"===this.connectionStatus?(this._connectPromise=null,this._disconnectPromise||(this._disconnectPromise=o.once(this,"connectionStatus").then(function(e){if("disconnected"===e.value)return this._connect()}.bind(this))),this._disconnectPromise):void 0},disconnect:function(){var e=this.connectionStatus;"connected"===e?(this._set("connectionStatus","disconnecting"),this._socket?this._socket.close():this._set("connectionStatus","disconnected")):"connecting"===e&&this._connectPromise.then(function(){this.disconnect()}.bind(this))},send:function(e){this._socket&&("object"==typeof e&&(e=JSON.stringify(e)),this._socket.send(e))},_connect:function(){this._connectPromise&&(this._connectPromise=null);var e=n.createDeferred();return this._connectPromise=e,this._getWebSocketToken().then(function(e){e&&(this.queryParams.token=e);var t=this._makeCurrentUrl(),r=new WebSocket(t);r.onopen=this._handleSocketOpen.bind(this),r.onclose=this._handleSocketClose.bind(this),r.onmessage=this._handleSocketMessage.bind(this),this._socket=r}.bind(this)).catch(function(e){var t=new i("web-socket-connector:connect","Could not get websocket token for secured service",e);this._set("connectionError",t),this._connectPromise.reject(t)}.bind(this)),e.promise},_getWebSocketToken:function(){var e=this.queryParams,t=e&&e.token,r=this.tokenNeeded;return t?n.resolve(t):r?this.layerSource.getWebSocketToken():n.resolve()},_makeCurrentUrl:function(){var e,t,n=this.queryParams,o=this.socketUrls;return 1!==o.length&&this.currentSocketUrl?(e=o.indexOf(this.currentSocketUrl),t=o[e>=o.length-1?0:e+1]):t=o[0],this._set("currentSocketUrl",t),n&&(t+="?"+r.objectToQuery(n)),t},_handleSocketOpen:function(){this._set("connectionStatus","connected"),this._set("connectionError",null),this._disconnectPromise=null,this._connectPromise&&this._connectPromise.resolve()},_handleSocketClose:function(e){var t,r=null;this.queryParams&&(this.queryParams.token=null),e.wasClean&&!e.code||(1001===e.code?t="Service is going away.":4400===e.code?t=e.reason||"Invalid url parameters. Check filter properties.":4404===e.code?t="Service not found":4401===e.code||4403===e.code?t="Not authorized":e.wasClean||(t=e.reason||"Unknown reason"),t&&(r=new i("web-socket-connector:connection closed","Connection failed: "+t),this._set("connectionError",r),this._connectPromise&&this._connectPromise.reject(r))),this._connectPromise=null,this._set("connectionStatus","disconnected"),this._socket=null},_handleSocketMessage:function(e){this.emit("data-received",e.data)}})}.apply(null,n))||(e.exports=o)}}]);